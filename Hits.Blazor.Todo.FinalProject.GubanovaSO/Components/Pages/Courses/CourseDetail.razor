@page "/courses/{CourseId:int}"
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Models
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Data.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject CourseService CourseService
@inject EnrollmentService EnrollmentService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(course?.Title ?? "Курс")</PageTitle>

<div class="container py-4">
    @if (course == null)
    {
        <div class="alert alert-danger">Курс не найден</div>
        <a href="/courses" class="btn btn-primary">Назад к курсам</a>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <h2>@course.Title</h2>
                <p class="text-muted">@course.Category | @course.DurationHours ч</p>

                <h4 class="mt-4">Описание</h4>
                <p>@course.Description</p>

                <h4 class="mt-4">Содержание</h4>
                <div class="card card-body">
                    @if (string.IsNullOrWhiteSpace(course.Content))
                    {
                        <p class="text-muted">Содержание не добавлено</p>
                    }
                    else
                    {
                        @((MarkupString)course.Content.Replace("\n", "<br />"))
                    }
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <strong>Информация</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Категория:</strong> @course.Category</p>
                        <p><strong>Часов:</strong> @course.DurationHours</p>
                        <p><strong>Уровень:</strong> @course.DifficultyLevel</p>
                    </div>
                    <div class="card-footer">
                        <AuthorizeView>
                            <Authorized>
                                @if (isEnrolled)
                                {
                                    <button class="btn btn-secondary w-100" disabled>Вы записаны</button>
                                }
                                else
                                {
                                    <form method="post" action="/api/enroll">
                                        <input type="hidden" name="courseId" value="@CourseId" />
                                        <button type="submit" class="btn btn-success w-100">Записаться</button>
                                    </form>
                                }
                            </Authorized>
                            <NotAuthorized>
                                <a href="/Account/Login" class="btn btn-primary w-100">Вход</a>
                            </NotAuthorized>
                        </AuthorizeView>
                    </div>
                </div>

                <a href="/courses" class="btn btn-outline-primary w-100 mt-3">Назад</a>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int CourseId { get; set; }

    private Course? course;
    private bool isEnrolled = false;

    protected override async Task OnInitializedAsync()
    {
        course = await CourseService.GetCourseByIdAsync(CourseId);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true && course != null)
        {
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                var enrollment = await EnrollmentService.GetEnrollmentAsync(userId, CourseId);
                isEnrolled = enrollment != null;
            }
        }
    }
}
